<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SyncDancer</title>
</head>
<body style="margin: 0; height: 100%; width: 100%; overflow: hidden">
<script src="./VideoTime.js"></script>
<script src="./Tapper.js"></script>
<script src="./DanceCanvas.js"></script>
<script src="./libgif.js"></script>
<script>
    const gifs = {
        "duck": {
            url: './Loop%20Videos/duck_32.gif',
            offset: 11,
            beats: 32,
        },
        "triangle": {
            url: './Loop%20Videos/triangle_4.gif',
            offset: 0,
            beats: 4,
        }
    };
</script>
<script>
    let videos = [];
    const dance = new DanceCanvas();

    for (let gifName in gifs) {
        const g = gifs[gifName];
        const element = document.createElement('img');
        document.body.append(element);
        element.src = g.url;
        const sg = new SuperGif({gif: element});
        sg.load(() => {
            sg.pause();

            videos.push(new VideoTime(element, g.offset, sg.get_length(), g.beats, vT => {
                const frame = (vT.offset + vT.fraction * vT.loopLength) % sg.get_length();
                sg.move_to(frame);
            }));
            dance.addGif(gifName, sg.get_canvas());
        });
        sg.get_canvas().hidden = true;
    }
    dance.mode = "TILE";
    dance.toDraw = ["duck", "triangle"];

    const tapper = new Tapper();

    document.addEventListener('keydown', ev => {
        tapper.tap(ev.timeStamp);
    });

    function doubleTime() {
        tapper.multiply(0.5);
    }
    function halfTime() {
        tapper.multiply(2);
    }

    function update(time) {
        const nextBeat = tapper.whenNextBeat(time);
        for (let v of videos) {
            v.update(time, tapper.lastBeat, nextBeat);
        }
        dance.draw();
        requestAnimationFrame(update);
    }

    requestAnimationFrame(update);
</script>

</body>
</html>